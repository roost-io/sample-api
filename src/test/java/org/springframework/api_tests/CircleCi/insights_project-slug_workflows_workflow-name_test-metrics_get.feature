# ********RoostGPT********

# Test generated by RoostGPT for test karateCircleCIFile using AI Type Claude AI and AI Model claude-3-7-sonnet-20250219
# 
# Feature file generated for /insights/{project-slug}/workflows/{workflow-name}/test-metrics_get for http method type GET 
# RoostTestHash=1e497c49fd
# 
# 

# ********RoostGPT********
Feature: Test metrics for a project's workflows

  Background:
    * def urlBase = karate.properties['URL_BASE']
    * def authHeader = { Authorization: 'Basic ' + karate.properties['API_KEY'] }

  Scenario: Get test metrics for a project's workflow with default branch
    Given url urlBase
    And path '/insights/gh/CircleCI-Public/api-preview-docs/workflows/build-and-test/test-metrics'
    And headers authHeader
    When method GET
    Then status 200
    And match response ==
      """
      {
        average_test_count: '#number',
        most_failed_tests: '#array',
        most_failed_tests_extra: '#number',
        slowest_tests: '#array',
        slowest_tests_extra: '#number',
        total_test_runs: '#number',
        test_runs: '#array'
      }
      """
    And match response.average_test_count == '#number'
    And match response.average_test_count >= 0
    And match response.most_failed_tests_extra == '#number'
    And match response.most_failed_tests_extra >= 0
    And match response.slowest_tests_extra == '#number'
    And match response.slowest_tests_extra >= 0
    And match response.total_test_runs == '#number'
    And match response.total_test_runs >= 0
    And match each response.most_failed_tests ==
      """
      {
        p95_duration: '##number',
        total_runs: '#number',
        classname: '##string',
        failed_runs: '#number',
        flaky: '#boolean',
        source: '##string',
        file: '##string',
        job_name: '#string',
        test_name: '#string'
      }
      """
    And match each response.most_failed_tests[*].total_runs >= 0
    And match each response.most_failed_tests[*].failed_runs >= 0
    And match each response.slowest_tests ==
      """
      {
        p95_duration: '##number',
        total_runs: '#number',
        classname: '##string',
        failed_runs: '#number',
        flaky: '#boolean',
        source: '##string',
        file: '##string',
        job_name: '#string',
        test_name: '#string'
      }
      """
    And match each response.slowest_tests[*].total_runs >= 0
    And match each response.slowest_tests[*].failed_runs >= 0
    And match each response.test_runs ==
      """
      {
        pipeline_number: '#number',
        workflow_id: '#present',
        success_rate: '#number',
        test_counts: {
          error: '#number',
          failure: '#number',
          skipped: '#number',
          success: '#number',
          total: '#number'
        }
      }
      """
    And match each response.test_runs[*].pipeline_number >= 0
    And match each response.test_runs[*].test_counts.error >= 0
    And match each response.test_runs[*].test_counts.failure >= 0
    And match each response.test_runs[*].test_counts.skipped >= 0
    And match each response.test_runs[*].test_counts.success >= 0
    And match each response.test_runs[*].test_counts.total >= 0

  Scenario: Get test metrics for a project's workflow with specific branch
    Given url urlBase
    And path '/insights/gh/CircleCI-Public/api-preview-docs/workflows/build-and-test/test-metrics'
    And param branch = 'main'
    And headers authHeader
    When method GET
    Then status 200
    And match response ==
      """
      {
        average_test_count: '#number',
        most_failed_tests: '#array',
        most_failed_tests_extra: '#number',
        slowest_tests: '#array',
        slowest_tests_extra: '#number',
        total_test_runs: '#number',
        test_runs: '#array'
      }
      """
    And match response.average_test_count == '#number'
    And match response.average_test_count >= 0
    And match response.total_test_runs == '#number'
    And match response.total_test_runs >= 0

  Scenario: Get test metrics for a project's workflow with all branches
    Given url urlBase
    And path '/insights/gh/CircleCI-Public/api-preview-docs/workflows/build-and-test/test-metrics'
    And param all-branches = true
    And headers authHeader
    When method GET
    Then status 200
    And match response ==
      """
      {
        average_test_count: '#number',
        most_failed_tests: '#array',
        most_failed_tests_extra: '#number',
        slowest_tests: '#array',
        slowest_tests_extra: '#number',
        total_test_runs: '#number',
        test_runs: '#array'
      }
      """
    And match response.average_test_count == '#number'
    And match response.average_test_count >= 0
    And match response.total_test_runs == '#number'
    And match response.total_test_runs >= 0

  Scenario Outline: Get test metrics with different project slugs and workflow names
    Given url urlBase
    And path '/insights/<project-slug>/workflows/<workflow-name>/test-metrics'
    And headers authHeader
    When method GET
    Then status 200
    And match response ==
      """
      {
        average_test_count: '#number',
        most_failed_tests: '#array',
        most_failed_tests_extra: '#number',
        slowest_tests: '#array',
        slowest_tests_extra: '#number',
        total_test_runs: '#number',
        test_runs: '#array'
      }
      """

    Examples:
      | read('insights_project-slug_workflows_workflow-name_test-metrics_get.csv') |

  Scenario: Invalid project slug should return an error
    Given url urlBase
    And path '/insights/invalid-project/workflows/build-and-test/test-metrics'
    And headers authHeader
    When method GET
    Then status 400
    And match response.message == '#string'

  Scenario: Invalid workflow name should return an error
    Given url urlBase
    And path '/insights/gh/CircleCI-Public/api-preview-docs/workflows/non-existent-workflow/test-metrics'
    And headers authHeader
    When method GET
    Then status 404
    And match response.message == '#string'

  Scenario: Using both branch and all-branches parameters should return an error
    Given url urlBase
    And path '/insights/gh/CircleCI-Public/api-preview-docs/workflows/build-and-test/test-metrics'
    And param branch = 'main'
    And param all-branches = true
    And headers authHeader
    When method GET
    Then status 400
    And match response.message == '#string'
